---
title: "data_collection"
author: "Sujan Bhattarai"
date: "2024-02-02"
output: html_document
---

```{r}
# load the packages
library(dplyr)
library(RSQLite)
library(ggplot2)
```

```{r}
# create a connection to the database
soccer_dataset <- dbConnect(RSQLite::SQLite(), "data/soccer_data/database.sqlite")

# list all tables in the database
dbListTables(soccer_dataset)
```

```{r}
#create dataframe for each of this different tables from this database
Country <- dbGetQuery(soccer_dataset, "SELECT * FROM Country")
League  <- dbGetQuery(soccer_dataset, "SELECT * FROM League")
Match   <- dbGetQuery(soccer_dataset, "SELECT * FROM Match") 
Player  <- dbGetQuery(soccer_dataset, "SELECT * FROM Player")
Player_Attributes <- dbGetQuery(soccer_dataset, "SELECT * FROM Player_Attributes")
Team <- dbGetQuery(soccer_dataset, "SELECT * FROM Team")
Team_Attributes <- dbGetQuery(soccer_dataset, "SELECT * FROM Team_Attributes")

```

```{r}
# join country and league dataframes based on primary key country_id
country_league <- inner_join(Country, League, by = c("id" = "country_id"), suffix = c("_country", "_league"))

# join the country_league dataframe with the match dataframe based on primary key league_id and country_id
country_league_match <- inner_join(country_league, Match, 
                                   by = c("id_league" = "league_id", "id" = "country_id"), 
                                   suffix = c("_country_league", "_match"))

```
There is no primary key associated with country_league_match dataframe that I can use to join with player attributes. So, I will be considering these two dataframes separetely, and make visualization and analysis based on these two dataframes.

```{r}
# combine player and player_attributes dataframes based on primary key player_api_id
player_player_attributes <- inner_join(Player, Player_Attributes, 
                                       by = c("player_api_id" = "player_api_id"), 
                                       suffix = c("_player", "_player_attributes"))
```


Data Visualization steps: 
 - Distribution of shot power among players

```{r}
# plot the overall distribution of shot power among players
ggplot(player_player_attributes, aes(x = shot_power)) +
  geom_histogram(binwidth = 5, fill = "#E84D8A") +
  theme_minimal() +
  xlab("Shot power") +
  ylab("Frequency") +
  theme(axis.text = element_text(size = 10))

```

- Top 20 players with excellent shot power

```{r}
# player who has excellent shooting skills, i.e. shot_power > 90. The number 90 is entirely personal preference
excellent_shot_power <- player_player_attributes %>%
  filter(shot_power > 90) %>%
  select(player_name, shot_power, overall_rating) %>% 
  distinct(player_name, .keep_all = TRUE) %>% 
  arrange(desc(shot_power)) %>% 
  #filter top 20 players with excellent shot power
  head(20)

```

-Visualization of the top 20 players with their names

```{r}
#reorder the player_name in descending order of shot_power
excellent_shot_power$player_name <- factor(excellent_shot_power$player_name, levels = excellent_shot_power$player_name)

#plot the players with excellent shot power
ggplot(excellent_shot_power, aes(y = player_name, x = shot_power)) +
  # plot with lollipop
  geom_segment(aes(x = 0, xend = shot_power, y = player_name, yend = player_name), color = "black") +
  # add points
  geom_point(shape = 20, fill = "black", color = "#E84D8A", size = 3) +
  # use minimal theme that has white background
  theme_minimal() +
  # rotate the y-axis text, set hjust to 1 to align 
  theme(axis.text.y = element_text(angle = 0, hjust = 1, vjust = 1)) +
  # remove the axis title for yaxis
  ylab("") +
  xlab("Shot power") +
  # remove the grid lines
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  # set the cartesian between 85 and 95 to highlight this area
  coord_cartesian(xlim = c(85, 95)) +
  # add the text label for shot power and put it to the left of the point
  geom_text(aes(label = shot_power), hjust = -0.5, size = 2) +
  #zoom into the area of interest
  scale_x_continuous(breaks = seq(85, 95, 5), labels = function(x) ifelse(x == 85, 0, x)) +
  #increase font size
  theme(axis.text = element_text(size = 10))

```

## Is there any association between shot power and overall ratings ?
```{r, warning=FALSE}
# read the player_player_attributes dataset, craete scatterplot and plot size based on overall rating
ggplot(player_player_attributes, aes(x = shot_power, y = overall_rating)) +
  geom_point(color = "#E84D8A", alpha = 0.01) +
  theme_minimal() +
  xlab("Shot power") +
  ylab("Overall rating") +
  theme(axis.text = element_text(size = 10)) +
  scale_size_continuous(range = c(1, 10)) + 
  #fit a linear model to the data
  geom_smooth(method = "lm", se = FALSE, color = "#7f58AF")

```

## Answers
1. The dataset is really huge, and it contains every minor details for each of the players that played league. This data can be excellent for predictive Machine learning models,considering such a fine grained data. This is already a cleaned version of data, which I did not like much. Each tables are supposed to be joined with primary id from another table, for one sets of table I am not finding the primary and foreign keys. Nonetheless, I plotted distribution and trend for some variables, and I can observe patterns in the data. for example, there is clear positive association between powerful shot and overall rating. 

2. I proposed a question trying to see if younger players scores goals more than elder players. But, I am little worried about how am i going to classify the players, also i didn't find the number of goals scored per player. Instead of looking at the goals, I am thinking of looking at agility of player, which might help me classify players.  I have not yet stride to that part, i was more curious about which soccer player has the most powerful shot. To move towards my questions, I need to calculate age for players, classify them, and look at their overall ratings. Also, I need to drop the list of players because I don't want to do the analysis for every single players. I will summarize the data, or I am considering club wise grouping would be suitable. Then chose a suitable plot. I don't have clear idea what plot I will use, I will probably go explore new chart types in google.

3. I think chosing right plot is going to be difficult in my case. Data wrangling part is a bit mess too, cause I need to find primary and foreign key for all tables so that I can join those two tables but i have not found for one. I also see a challenge in selecting variables, because there are several variables that defines younger and elder player. Being able to correctly select them is going to be a huge challenge. for example: younger player are supposed to have higher agility, but i don't think that would be the case in regards to trained players. Also what age is a younger player, is it 24, 25 or ? I might  have to rephrase my research questions.

